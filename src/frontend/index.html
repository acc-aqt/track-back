<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TrackBack Game</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
        max-width: 600px;
        margin: auto;
      }
      #log {
        white-space: pre-wrap;
        background: #f9f9f9;
        padding: 1rem;
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        margin-top: 1rem;
      }
      input,
      button {
        padding: 0.5rem;
        font-size: 1rem;
      }
      #guess-area {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>ğŸµ TrackBack Game</h1>
    <label
      >Server: <input id="server" placeholder="e.g. 192.168.1.45:4200" /></label
    ><br />
    <label>Username: <input id="username" placeholder="e.g. Alex" /></label>
    <button id="connectBtn">Connect</button>
    <button id="startGameBtn">Start Game</button>
    <button id="stopServerBtn">ğŸ›‘ Stop Server</button>

    <div id="game" style="display: none">
      <div id="songList"></div>
      <div id="guess-area">
        <label>ğŸ“ Insert index: <input id="indexInput" type="number" /></label>
        <button id="sendGuess">Send Guess</button>
      </div>
      <div id="log"></div>
    </div>

    <script>
      let socket;
      let username;

      const log = (msg) => {
        const logBox = document.getElementById("log");
        logBox.textContent += msg + "\n";
        logBox.scrollTop = logBox.scrollHeight;
      };

      document.getElementById("connectBtn").onclick = async () => {
        const username = document.getElementById("username").value;
        const serverInput = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");

        if (!username || !serverInput) {
          alert("Please enter both server address and username.");
          return;
        }

        let urlObj;
        try {
          urlObj = new URL(serverInput);
        } catch (e) {
          alert(
            "âš ï¸ Invalid server address. Please use something like http://192.168.x.x:4200"
          );
          return;
        }

        const wsProtocol = urlObj.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${urlObj.host}/ws/${username}`;

        console.log("ğŸŒ Connecting to", wsUrl); // âœ… Now it's after declaration!

        try {
          socket = new WebSocket(wsUrl);

          socket.onopen = () => {
            console.log("âœ… WebSocket connection opened");
            log(`ğŸ›°ï¸ Connected as ${username}`);
            document.getElementById("game").style.display = "block";
          };

          socket.onerror = (e) => {
            console.error("ğŸš¨ WebSocket error:", e);
            log("ğŸš¨ WebSocket connection error. Check the server address.");
          };

          socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("ğŸ“¬ Received:", data);

            const type = data.type;

            if (type === "your_turn" && data.next_player === username) {
              log(`ğŸ® It's your turn!`);

              const list = data.song_list || [];
              const songListHtml = list
                .map(
                  (s, i) =>
                    `[${i}] ${s.release_year} - "${s.title}" by ${s.artist}`
                )
                .join("<br>");
              document.getElementById(
                "songList"
              ).innerHTML = `<strong>ğŸ“» Your song list:</strong><br>${songListHtml}`;
            } else if (type === "guess_result" && data.player === username) {
              log(`ğŸ¯ ${data.result.toUpperCase()}: ${data.message}`);

              // â¬‡ï¸ Immediately update song list
              const list = data.song_list || [];
              const songListHtml = list
                .map(
                  (s, i) =>
                    `[${i}] ${s.release_year} - "${s.title}" by ${s.artist}`
                )
                .join("<br>");
              document.getElementById(
                "songList"
              ).innerHTML = `<strong>ğŸ“» Your song list:</strong><br>${songListHtml}`;
            } else if (type === "welcome") {
              log(`ğŸ‘‹ ${data.message}`);
            } else if (type === "turn_result") {
              log(`ğŸª„ ${data.player} played: ${data.message}`);
            } else if (type === "game_over") {
              log(`ğŸ Game Over! Winner: ${data.winner}`);
            } else {
              log(`ğŸ“¬ Unhandled message: ${JSON.stringify(data, null, 2)}`);
            }
          };

          socket.onclose = (e) => {
            console.warn("ğŸ”Œ WebSocket closed:", e);
            log("ğŸ”Œ Connection closed.");
          };
        } catch (err) {
          console.error("âŒ Failed to create WebSocket:", err);
          return;
        }
      };
      document.getElementById("startGameBtn").onclick = async () => {
        const serverInput = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");

        let urlObj;
        try {
          urlObj = new URL(serverInput);
        } catch (e) {
          alert(
            "âš ï¸ Invalid server address. Please enter a valid URL like http://192.168.x.x:4200"
          );
          return;
        }

        const startUrl = `${urlObj.origin}/start`;

        try {
          const res = await fetch(startUrl, { method: "POST" });
          const data = await res.json();
          console.log("ğŸ® Game start response:", data);
          log(`ğŸ® ${data.message || "Game started!"}`);
        } catch (err) {
          console.error("âŒ Failed to start game:", err);
          log("âŒ Failed to start the game. Check the server and try again.");
        }
      };
      document.getElementById("sendGuess").onclick = () => {
        const index = parseInt(document.getElementById("indexInput").value);
        if (isNaN(index)) {
          alert("Please enter a valid number.");
          return;
        }

        socket.send(
          JSON.stringify({
            type: "guess",
            index: index,
          })
        );

        log(`ğŸ“¤ Sent guess at index ${index}`);
        document.getElementById("indexInput").value = "";
      };

      document.getElementById("stopServerBtn").onclick = async () => {
        const serverUrl = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");
        let urlObj;
        try {
          urlObj = new URL(serverUrl);
        } catch (e) {
          alert("Invalid server URL");
          return;
        }

        const shutdownUrl = `${urlObj.origin}/shutdown`;
        try {
          const res = await fetch(shutdownUrl, { method: "POST" });
          const data = await res.json();
          log(`ğŸ›‘ ${data.message}`);
        } catch (err) {
          console.error("âŒ Failed to stop server:", err);
          log("âŒ Failed to stop the server. Is it still running?");
        }
      };
    </script>
  </body>
</html>
