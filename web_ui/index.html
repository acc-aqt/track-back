<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TrackBack Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
        max-width: 700px;
        margin: auto;
      }

      h1 {
        text-align: center;
      }

      #controls {
        background: #f1f1f1;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        justify-content: space-between;
      }

      #controls input {
        padding: 0.4rem;
        font-size: 1rem;
      }

      #newSongContainer {
        margin-bottom: 1.5rem;
      }

      #songTimeline.drop-box {
        border: 2px dashed #bbb;
        padding: 1rem;
        min-height: 100px;
        border-radius: 8px;
        background-color: #fdfdfd;
        transition: background 0.3s;
      }

      #songTimeline.drop-box.drag-active {
        background-color: #e6f7ff;
      }

      button {
        padding: 0.5rem 0.75rem;
        font-size: 1rem;
        cursor: pointer;
      }

      .song-entry {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0.5rem;
        background-color: #fff;
      }

      .song-cover {
        width: 80px;
        border-radius: 6px;
      }

      .song-details {
        flex: 1;
      }

      .highlight {
        background-color: #e6f7ff;
      }

      #log {
        white-space: pre-wrap;
        background: #fafafa;
        padding: 1rem;
        border: 1px solid #ccc;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.9rem;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>üéµ TrackBack Game</h1>

    <div id="controls">
      <label
        >Server:
        <input
          id="server"
          placeholder="https://your-app.onrender.com"
          size="30"
        />
      </label>
      <label
        >Username:
        <input id="username" />
      </label>
      <button id="connectBtn">Connect</button>
      <button id="startGameBtn">Start Game</button>
      <button id="stopServerBtn">üõë Stop Server</button>
    </div>

    <div id="game" style="display: none">
      <div id="newSongContainer"></div>

      <div id="songListHeader"><strong>üì¶ Song Timeline:</strong></div>
      <div id="songTimeline" class="drop-box"></div>

      <div id="log"></div>
    </div>

    <script>
      let socket;
      let username;

      const log = (msg) => {
        const logBox = document.getElementById("log");
        logBox.textContent += msg + "\n";
        logBox.scrollTop = logBox.scrollHeight;
      };

      const buildSongEntry = (song, id = "", extra = "") => {
        return `
    <div class="song-entry ${extra}" ${id ? `id="${id}"` : ""}>
      <img src="${song.album_cover_url}" alt="cover" class="song-cover" />
      <div class="song-details">
        <strong>${song.title}</strong> (${song.release_year})<br />
        by ${song.artist}
      </div>
    </div>
  `;
      };

      const buildSongListHtml = (list, newSong) => {
        let entries = list.map((s, i) => {
          return `
          <div class="song-entry" data-index="${i}">
            <img src="${s.album_cover_url}" alt="cover" class="song-cover" />
            <div class="song-details">
              <strong>${s.title}</strong> (${s.release_year})<br />
              by ${s.artist}
            </div>
          </div>`;
        });

        // Prepend the draggable guess song
        const newEntry = `
        <div class="song-entry highlight" id="new-song">
          <img src="${newSong.album_cover_url}" alt="cover" class="song-cover" />
          <div class="song-details">
            <strong>${newSong.title}</strong> (${newSong.release_year})<br />
            by ${newSong.artist}<br />
            <em>‚¨ÜÔ∏è Drag this song to the correct spot</em>
          </div>
        </div>`;

        return newEntry + entries.join("");
      };

      document.getElementById("connectBtn").onclick = async () => {
        username = document.getElementById("username").value;
        const serverInput = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");

        if (!username || !serverInput) {
          alert("Please enter both server address and username.");
          return;
        }

        let urlObj;
        try {
          urlObj = new URL(serverInput);
        } catch (e) {
          alert("‚ö†Ô∏è Invalid server address.");
          return;
        }

        const wsProtocol = urlObj.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${urlObj.host}/ws/${username}`;

        try {
          socket = new WebSocket(wsUrl);

          socket.onopen = () => {
            log(`üõ∞Ô∏è Connected as ${username}`);
            document.getElementById("game").style.display = "block";
          };

          socket.onerror = (e) => {
            console.error("üö® WebSocket error:", e);
            log("üö® Connection error");
          };

          socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const type = data.type;

            if (type === "your_turn" && data.next_player === username) {
              log(`üéÆ It's your turn! Drag the new song into the right place.`);
              const list = data.song_list || [];
              const newSong = data.new_song || {
                title: "New Song",
                artist: "Unknown",
                release_year: "????",
                album_cover_url: "https://via.placeholder.com/80",
              };

              document.getElementById("newSongContainer").innerHTML = `
  <strong>üéØ Drag this song into the timeline below:</strong>
  ${buildSongEntry(newSong, "new-song", "highlight")}
`;

              document.getElementById("songTimeline").innerHTML = list
                .map((s) => buildSongEntry(s))
                .join("");

              setupDragDrop(list.length);
            } else if (type === "guess_result" && data.player === username) {
              log(`üéØ ${data.result.toUpperCase()}: ${data.message}`);
              const list = data.song_list || [];
              document.getElementById("songList").innerHTML = buildSongListHtml(
                list,
                {}
              );
            } else if (type === "welcome") {
              log(`üëã ${data.message}`);
            } else if (type === "error") {
              log(`üö® Error: ${data.message}`);
            } else if (type === "turn_result") {
              log(`ü™Ñ ${data.player} played: ${data.message}`);
            } else if (type === "game_over") {
              log(`üèÅ Game Over! Winner: ${data.winner}`);
            }
          };

          socket.onclose = (e) => {
            log("üîå Connection closed.");
          };
        } catch (err) {
          console.error("‚ùå Failed to connect:", err);
        }
      };

      const setupDragDrop = () => {
        const timeline = document.getElementById("songTimeline");
        const newSongContainer = document.getElementById("newSongContainer");

        // Timeline ‚Äì where songs are dropped
        new Sortable(timeline, {
          group: "songs",
          animation: 150,
          ghostClass: "drag-ghost",
          onAdd: (evt) => {
            if (evt.item.id === "new-song") {
              const newIndex = evt.newIndex;
              log(`üì§ Guess submitted: insert at index ${newIndex}`);
              socket.send(JSON.stringify({ type: "guess", index: newIndex }));
            }
          },
          onStart: () => {
            timeline.classList.add("drag-active");
          },
          onEnd: () => {
            timeline.classList.remove("drag-active");
          },
        });

        // New song container ‚Äì where drag starts
        new Sortable(newSongContainer, {
          group: "songs", // must match
          sort: false, // can't rearrange in this container
        });
      };

      document.getElementById("startGameBtn").onclick = async () => {
        const serverInput = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");
        let urlObj;
        try {
          urlObj = new URL(serverInput);
        } catch (e) {
          alert("Invalid server address");
          return;
        }

        const startUrl = `${urlObj.origin}/start`;

        try {
          const res = await fetch(startUrl, { method: "POST" });
          const data = await res.json();
          log(`üéÆ ${data.message || "Game started!"}`);
        } catch (err) {
          log("‚ùå Failed to start the game.");
        }
      };

      document.getElementById("stopServerBtn").onclick = async () => {
        const serverUrl = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");
        let urlObj;
        try {
          urlObj = new URL(serverUrl);
        } catch (e) {
          alert("Invalid server URL");
          return;
        }

        const shutdownUrl = `${urlObj.origin}/shutdown`;
        try {
          const res = await fetch(shutdownUrl, { method: "POST" });
          const data = await res.json();
          log(`üõë ${data.message}`);
        } catch (err) {
          log("‚ùå Failed to stop the server.");
        }
      };
    </script>
  </body>
</html>
