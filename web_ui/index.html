<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TrackBack Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
        max-width: 700px;
        margin: auto;
        background-color: #ffffff;
        color: #333;
      }

      h1 {
        text-align: center;
        margin-bottom: 1rem;
      }

      #controls {
        background: #f1f1f1;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        justify-content: space-between;
      }

      #controls input {
        padding: 0.4rem;
        font-size: 1rem;
      }

      button {
        padding: 0.5rem 0.75rem;
        font-size: 1rem;
        cursor: pointer;
      }

      #songList {
        margin-top: 1rem;
      }

      .song-index-label {
        font-weight: bold;
        margin-bottom: 0.25rem;
        font-family: monospace;
        font-size: 1.1rem;
      }

      .arrow {
        display: inline-block;
        margin-left: 0.5rem;
        color: #888;
      }

      .song-entry {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-left: 2rem;
      }

      .song-cover {
        width: 80px;
        border-radius: 6px;
      }

      .song-details {
        flex: 1;
      }

      #guess-area {
        margin-top: 1rem;
      }

      #log {
        white-space: pre-wrap;
        background: #fafafa;
        padding: 1rem;
        border: 1px solid #ccc;
        height: 250px;
        overflow-y: auto;
        margin-top: 1.5rem;
        font-family: monospace;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <h1>üéµ TrackBack Game</h1>

    <div id="controls">
      <label
        >Server:
        <input
          id="server"
          placeholder="e.g. http://192.168.178.55:4200"
          size="30"
        />
      </label>
      <label
        >Username:
        <input id="username" />
      </label>
      <button id="connectBtn">Connect</button>
      <button id="startGameBtn">Start Game</button>
      <button id="stopServerBtn">üõë Stop Server</button>
    </div>

    <div id="game" style="display: none">
      <div id="songListHeader"><strong>üìª Your song list:</strong></div>
      <div id="songList"></div>

      <div id="guess-area">
        <label for="indexInput" id="guessLabel">üìç Insert index:</label>
        <input id="indexInput" type="number" />
        <button id="sendGuess">Send Guess</button>
      </div>

      <div id="log"></div>
    </div>

    <script>
      let socket;
      let username;

      const log = (msg) => {
        const logBox = document.getElementById("log");
        logBox.textContent += msg + "\n";
        logBox.scrollTop = logBox.scrollHeight;
      };

      const buildSongListHtml = (list) => {
        return list
          .map(
            (s, i) => `
      <div class="song-index-label">
        ${i} <span class="arrow">‚ü∂</span>
      </div>
      <div class="song-entry">
        <img src="${s.album_cover_url}" alt="cover" class="song-cover" />
        <div class="song-details">
          <strong>${s.title}</strong> (${s.release_year})<br />
          by ${s.artist}
        </div>
      </div>
    `
          )
          .join("");
      };

      document.getElementById("connectBtn").onclick = async () => {
        username = document.getElementById("username").value;
        const serverInput = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");

        if (!username || !serverInput) {
          alert("Please enter both server address and username.");
          return;
        }

        let urlObj;
        try {
          urlObj = new URL(serverInput);
        } catch (e) {
          alert("‚ö†Ô∏è Invalid server address. Use http://192.168.x.x:4200");
          return;
        }

        const wsProtocol = urlObj.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${urlObj.host}/ws/${username}`;
        console.log("üåê Connecting to", wsUrl);

        try {
          socket = new WebSocket(wsUrl);

          socket.onopen = () => {
            console.log("‚úÖ WebSocket connection opened");
            log(`üõ∞Ô∏è Connected as ${username}`);
            document.getElementById("game").style.display = "block";
          };

          socket.onerror = (e) => {
            console.error("üö® WebSocket error:", e);
            log("üö® WebSocket connection error. Check the server address.");
          };

          socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("üì¨ Received:", data);
            const type = data.type;

            if (type === "your_turn" && data.next_player === username) {
              log(`üéÆ It's your turn!`);
              const list = data.song_list || [];
              const validRange = `(0‚Äì${list.length})`;
              document.getElementById(
                "guessLabel"
              ).innerText = `üìç Enter the index of the song before which you want to insert ${validRange}:`;
              document.getElementById("songList").innerHTML =
                buildSongListHtml(list);
            } else if (type === "guess_result" && data.player === username) {
              log(`üéØ ${data.result.toUpperCase()}: ${data.message}`);
              const list = data.song_list || [];
              document.getElementById("songList").innerHTML =
                buildSongListHtml(list);
            } else if (type === "welcome") {
              log(`üëã ${data.message}`);
            } else if (type === "error") {
              log(`üö® Error: ${data.message}`);
            } else if (type === "turn_result") {
              log(`ü™Ñ ${data.player} played: ${data.message}`);
            } else if (type === "game_over") {
              log(`üèÅ Game Over! Winner: ${data.winner}`);
            } else {
              log(`üì¨ Unhandled message: ${JSON.stringify(data, null, 2)}`);
            }
          };

          socket.onclose = (e) => {
            console.warn("üîå WebSocket closed:", e);
            log("üîå Connection closed.");
          };
        } catch (err) {
          console.error("‚ùå Failed to create WebSocket:", err);
        }
      };

      document.getElementById("startGameBtn").onclick = async () => {
        const serverInput = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");

        let urlObj;
        try {
          urlObj = new URL(serverInput);
        } catch (e) {
          alert("‚ö†Ô∏è Invalid server address.");
          return;
        }

        const startUrl = `${urlObj.origin}/start`;

        try {
          const res = await fetch(startUrl, { method: "POST" });
          const data = await res.json();
          log(`üéÆ ${data.message || "Game started!"}`);
        } catch (err) {
          console.error("‚ùå Failed to start game:", err);
          log("‚ùå Failed to start the game.");
        }
      };

      document.getElementById("sendGuess").onclick = () => {
        const index = parseInt(document.getElementById("indexInput").value);
        if (isNaN(index)) {
          alert("Please enter a valid number.");
          return;
        }

        socket.send(JSON.stringify({ type: "guess", index }));
        log(`üì§ Sent guess at index ${index}`);
        document.getElementById("indexInput").value = "";
      };

      document.getElementById("stopServerBtn").onclick = async () => {
        const serverUrl = document
          .getElementById("server")
          .value.trim()
          .replace(/\/+$/, "");

        let urlObj;
        try {
          urlObj = new URL(serverUrl);
        } catch (e) {
          alert("Invalid server URL");
          return;
        }

        const shutdownUrl = `${urlObj.origin}/shutdown`;
        try {
          const res = await fetch(shutdownUrl, { method: "POST" });
          const data = await res.json();
          log(`üõë ${data.message}`);
        } catch (err) {
          console.error("‚ùå Failed to stop server:", err);
          log("‚ùå Failed to stop the server.");
        }
      };
    </script>
  </body>
</html>
